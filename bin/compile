#!/bin/bash

# fail fast
set -o errexit
set -o nounset
set -o pipefail

indent() {
  sed -u 's/^/       /'
}

scriptname=$(basename $0)
case $# in
  2) :;;
  *) echo "$scriptname: usage: $scriptname BUILD_DIR CACHE_DIR" >&2; exit 2;;
esac

build_dir="$1"
cache_dir="$2"
ccache_max_size=50G
num_cpu=$(grep -c ^bogomips /proc/cpuinfo)

export CCACHE_DIR=$cache_dir/ccache
export PATH=/usr/lib/ccache:$PATH
export MAVEN_OPTS=-Dmaven.repo.local=$cache_dir/m2/repository
export DEB_BUILD_OPTIONS="ccache parallel=$num_cpu"

echo "-----> Parsing debian/changelog"
if test -f $build_dir/debian/rules
then
  # Update debian/changelog if necessary to include development version
  cd $build_dir >/dev/null 2>&1
  if test -d $build_dir/.git
  then
    changelog_version=$(dpkg-parsechangelog | sed -ne 's,Version: ,,p' | sed 's/-.*$//')
    tag=$(git tag | egrep '^(\w*[^0-9])?'"$changelog_version"'$' || : | head -n 1)
    case "$tag" in
      '') tagged_commit=;;
      *) tagged_commit=$(git rev-list -n 1 "$tag");;
    esac
    commit=$(git log -n 1 | awk '$1 == "commit" {print $2}')
    case "$tagged_commit" in
      "$commit")
        echo "       Found version: $changelog_version (release)"
        ;;
      '')
        case "$changelog_version" in
          *[a-z]*)
            echo "       Found version: $changelog_version (post-release)"
            deb_separator='+'
            deb_flags=
            ;;
          *)
            echo "       Found version: $changelog_version (pre-release)"
            deb_separator='~'
            deb_flags='-b'
            ;;
          esac
        ;;
      *)
        echo "       Found version: $changelog_version (post-release)"
        deb_separator='+'
        deb_flags=
        ;;
    esac
    case "$tagged_commit" in
      "$commit")
        echo "       Not modifying debian/changelog"
        ;;
      *)
        deb_timestamp=$(date +%Y%m%d%H%M%S)
        deb_extra=dev.g$(echo $commit | sed 's/^\(.\{7\}\).*/\1/')
        deb_email='builder@cherrybuild.com'
        deb_full_name='Cherrybuild'
        deb_version=$changelog_version${deb_separator}$deb_timestamp.$deb_extra-1
        echo "       Adding entry to debian/changelog: $deb_version"
        env DEBEMAIL=$deb_email DEBFULLNAME=$deb_full_name debchange $deb_flags -v $deb_version Development snapshot $deb_version 2>&1 | indent
        ;;
    esac
  fi
  cd - >/dev/null 2>&1

  # dpkg-buildpackage wants to generate the .deb files in ..
  # so we have to copy the repo one level inside into .build
  sub_dir=$build_dir/.app
  echo "-----> Copying sources into .build"
  mkdir -p $sub_dir
  tar -C $build_dir -cf $cache_dir/app.tar .
  tar -C $sub_dir -xf $cache_dir/app.tar
  rm -f $cache_dir/app.tar
else
  echo "-----> Unpacking sources"
  cd $build_dir >/dev/null 2>&1
  dpkg-source -x *.dsc 2>&1 | indent
  cd - >/dev/null 2>&1
  sub_dir=$(dirname $(dirname $(ls $build_dir/*/debian/rules | head -n1)))
fi

echo "-----> Zeroing ccache stats"
ccache -M $ccache_max_size 2>&1 | indent
ccache -z 2>&1 | indent

echo "-----> Building package"
cd $sub_dir >/dev/null 2>&1
dpkg-buildpackage -j$num_cpu -rfakeroot -b 2>&1 | indent
cd - >/dev/null 2>&1
